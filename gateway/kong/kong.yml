# PlansiteOS Kong Gateway Configuration
# Version: 3.1
# Format: Kong Declarative Config (DB-less mode)

_format_version: "3.0"
_transform: true

# =============================================================================
# Services
# =============================================================================

services:
  # Parsing Service
  - name: parsing-service
    url: http://parsing:8080
    protocol: http
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 120000
    retries: 3
    tags:
      - plansiteos
      - parsing
    routes:
      - name: parsing-routes
        paths:
          - /api/v1/parse
          - /api/v1/blueprints
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: false
        preserve_host: true
        tags:
          - parsing

  # Vision Service
  - name: vision-service
    url: http://vision:8081
    protocol: http
    connect_timeout: 60000
    write_timeout: 120000
    read_timeout: 300000  # Longer timeout for ML inference
    retries: 2
    tags:
      - plansiteos
      - vision
      - ml
    routes:
      - name: vision-routes
        paths:
          - /api/v1/vision
          - /api/v1/detect
        methods:
          - GET
          - POST
        strip_path: false
        preserve_host: true
        tags:
          - vision

  # Estimation Service
  - name: estimation-service
    url: http://estimation:8082
    protocol: http
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 120000
    retries: 3
    tags:
      - plansiteos
      - estimation
    routes:
      - name: estimation-routes
        paths:
          - /api/v1/estimate
          - /api/v1/costs
        methods:
          - GET
          - POST
          - PUT
        strip_path: false
        preserve_host: true
        tags:
          - estimation

  # Rendering Service
  - name: rendering-service
    url: http://rendering:8083
    protocol: http
    connect_timeout: 60000
    write_timeout: 120000
    read_timeout: 180000
    retries: 2
    tags:
      - plansiteos
      - rendering
    routes:
      - name: rendering-routes
        paths:
          - /api/v1/render
          - /api/v1/outputs
        methods:
          - GET
          - POST
        strip_path: false
        preserve_host: true
        tags:
          - rendering

  # AI Assistant Service
  - name: assistant-service
    url: http://assistant:8084
    protocol: http
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 300000  # Long timeout for LLM responses
    retries: 1
    tags:
      - plansiteos
      - assistant
      - ai
    routes:
      - name: assistant-routes
        paths:
          - /api/v1/chat
          - /api/v1/assistant
          - /api/v1/conversations
        methods:
          - GET
          - POST
          - DELETE
        strip_path: false
        preserve_host: true
        tags:
          - assistant

  # Health Check Aggregator
  - name: health-service
    url: http://parsing:8080
    protocol: http
    connect_timeout: 5000
    write_timeout: 5000
    read_timeout: 5000
    retries: 1
    tags:
      - plansiteos
      - health
    routes:
      - name: health-routes
        paths:
          - /health
          - /ready
          - /live
        methods:
          - GET
        strip_path: false
        tags:
          - health

# =============================================================================
# Upstreams (Load Balancing)
# =============================================================================

upstreams:
  - name: parsing-upstream
    algorithm: round-robin
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 5
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
    targets:
      - target: parsing:8080
        weight: 100

  - name: vision-upstream
    algorithm: round-robin
    healthchecks:
      active:
        healthy:
          interval: 30
          successes: 1
        unhealthy:
          interval: 10
          http_failures: 2
        http_path: /health
        timeout: 10
      passive:
        healthy:
          successes: 3
        unhealthy:
          http_failures: 3
    targets:
      - target: vision:8081
        weight: 100

  - name: estimation-upstream
    algorithm: round-robin
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 5
    targets:
      - target: estimation:8082
        weight: 100

  - name: rendering-upstream
    algorithm: round-robin
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
        http_path: /health
        timeout: 5
    targets:
      - target: rendering:8083
        weight: 100

  - name: assistant-upstream
    algorithm: round-robin
    healthchecks:
      active:
        healthy:
          interval: 30
          successes: 1
        unhealthy:
          interval: 10
          http_failures: 2
        http_path: /health
        timeout: 10
    targets:
      - target: assistant:8084
        weight: 100

# =============================================================================
# Plugins (Global)
# =============================================================================

plugins:
  # Request/Response Logging
  - name: file-log
    config:
      path: /var/log/kong/access.log
      reopen: true
    tags:
      - logging

  # Prometheus Metrics
  - name: prometheus
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
    tags:
      - metrics

  # CORS (Cross-Origin Resource Sharing)
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Correlation-ID
        - X-Request-ID
      exposed_headers:
        - X-Correlation-ID
        - X-Request-ID
      credentials: true
      max_age: 3600
    tags:
      - cors

  # Request ID (Correlation)
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid#counter
      echo_downstream: true
    tags:
      - tracing

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 100  # MB
      size_unit: megabytes
    tags:
      - security

  # Response Transformer (add headers)
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Powered-By:PlansiteOS/3.1"
          - "X-Frame-Options:DENY"
          - "X-Content-Type-Options:nosniff"
    tags:
      - security

# =============================================================================
# Service-Specific Plugins
# =============================================================================

  # Rate Limiting for Parsing Service
  - name: rate-limiting
    service: parsing-service
    config:
      minute: 60
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
    tags:
      - rate-limiting
      - parsing

  # Rate Limiting for Vision Service (lower due to GPU constraints)
  - name: rate-limiting
    service: vision-service
    config:
      minute: 20
      hour: 200
      policy: local
      fault_tolerant: true
      hide_client_headers: false
    tags:
      - rate-limiting
      - vision

  # Rate Limiting for Assistant Service (LLM constraints)
  - name: rate-limiting
    service: assistant-service
    config:
      minute: 30
      hour: 500
      policy: local
      fault_tolerant: true
      hide_client_headers: false
    tags:
      - rate-limiting
      - assistant

  # Request Transformer for Vision Service (add headers)
  - name: request-transformer
    service: vision-service
    config:
      add:
        headers:
          - "X-ML-Service:vision"
    tags:
      - vision

  # Request Transformer for Assistant Service
  - name: request-transformer
    service: assistant-service
    config:
      add:
        headers:
          - "X-ML-Service:assistant"
    tags:
      - assistant

# =============================================================================
# Consumers (API Keys - Example)
# =============================================================================

consumers:
  - username: plansiteos-frontend
    custom_id: frontend-app
    tags:
      - frontend

  - username: plansiteos-mobile
    custom_id: mobile-app
    tags:
      - mobile

  - username: plansiteos-integration
    custom_id: integration-api
    tags:
      - integration

# PlansiteOS Alerting Rules
# Version: 3.1

groups:
  # Service Health Alerts
  - name: service_health
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} has been down for more than 1 minute."

      - alert: ServiceHighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (job)
            /
            sum(rate(http_requests_total[5m])) by (job)
          ) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.job }}"
          description: "{{ $labels.job }} has error rate above 5% for 5 minutes."

      - alert: ServiceHighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency on {{ $labels.job }}"
          description: "95th percentile latency is above 2s for {{ $labels.job }}."

  # Processing Pipeline Alerts
  - name: processing_pipeline
    rules:
      - alert: BlueprintProcessingBacklog
        expr: |
          sum(blueprints_pending_total) > 100
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Blueprint processing backlog is high"
          description: "More than 100 blueprints pending for 15 minutes."

      - alert: VisionServiceSlowDetection
        expr: |
          histogram_quantile(0.95, sum(rate(vision_detection_duration_seconds_bucket[5m])) by (le)) > 30
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Vision service detection is slow"
          description: "95th percentile detection time is above 30s."

      - alert: EstimationServiceErrors
        expr: |
          sum(rate(estimation_errors_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Estimation service has errors"
          description: "Estimation service error rate is elevated."

      - alert: LLMInferenceSlowdown
        expr: |
          histogram_quantile(0.95, sum(rate(llm_inference_duration_seconds_bucket[5m])) by (le)) > 60
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "LLM inference is slow"
          description: "95th percentile LLM inference time is above 60s."

  # Resource Alerts
  - name: resources
    rules:
      - alert: HighCPUUsage
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 85% for 10 minutes."

      - alert: HighMemoryUsage
        expr: |
          (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)
          / node_memory_MemTotal_bytes * 100 > 90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 90% for 10 minutes."

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk space is low"
          description: "Less than 15% disk space remaining."

      - alert: GPUMemoryHigh
        expr: |
          nvidia_gpu_memory_used_bytes / nvidia_gpu_memory_total_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GPU memory usage is high"
          description: "GPU memory usage is above 90%."

  # Database Alerts
  - name: database
    rules:
      - alert: PostgresConnectionsHigh
        expr: |
          sum(pg_stat_activity_count) / sum(pg_settings_max_connections) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL connections are high"
          description: "More than 80% of max connections are in use."

      - alert: PostgresReplicationLag
        expr: |
          pg_replication_lag > 30
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL replication lag is high"
          description: "Replication lag is above 30 seconds."

      - alert: RedisMemoryHigh
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis memory usage is above 85%."

  # Queue Alerts
  - name: queues
    rules:
      - alert: NATSStreamLag
        expr: |
          nats_jetstream_consumer_num_pending > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "NATS JetStream consumer has high pending messages"
          description: "Consumer has more than 1000 pending messages."

      - alert: NATSSlowConsumer
        expr: |
          rate(nats_jetstream_consumer_num_redelivered[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "NATS consumer has high redelivery rate"
          description: "Messages are being redelivered frequently."

  # Business Metrics Alerts
  - name: business_metrics
    rules:
      - alert: LowFixtureConfidence
        expr: |
          avg(fixture_detection_confidence) < 0.75
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Average fixture detection confidence is low"
          description: "Average confidence score is below 75% for 30 minutes."

      - alert: EstimateAccuracyDrop
        expr: |
          avg(estimate_accuracy_score) < 0.85
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Estimate accuracy has dropped"
          description: "Average estimate accuracy is below 85% for 1 hour."
